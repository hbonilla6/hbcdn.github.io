function initMultiHBFiles(e=".hb-upload-container"){var t;let n=document.querySelector(e),l=n.querySelector(".hb-file-input-container"),i=l.querySelector(".hb-file-drop-area"),a=l.querySelector('input[type="file"]'),o=l.querySelector("button"),r=n.querySelector(".hb-preview-container"),s=JSON.parse(r.getAttribute("hb-files")||"[]"),d=document.getElementById("hb-fullscreenModal"),c=document.getElementById("hb-modalContent"),p=document.getElementById("hb-fileDetails"),u=document.getElementById("hb-closeModal"),h=document.getElementById("hb-dragHandle"),f=[],m=new Set;function y(e){e.preventDefault(),e.stopPropagation()}function g(){i.classList.add("highlight")}function v(){i.classList.remove("highlight")}function E(){d.style.display="none",c.innerHTML="",u.style.top="15px",u.style.left="auto",u.style.right="15px",p.style.top="auto",p.style.left="0",p.style.right="0",p.style.bottom="15px",document.body.classList.remove("hb-body-no-scroll")}function b(e){return`${e.name}-${e.size}`}function $(e){if(!e.length)return;let t=[];if(e.forEach(e=>{let n=b(e);if(m.has(n)){console.log(`Archivo duplicado ignorado: ${e.name}`);return}if(e.size<10){toastr.error(`El archivo "${e.name}" es demasiado peque\xf1o. Tama\xf1o m\xednimo: 10 bytes`);return}if(e.size>104857600){toastr.error(`El archivo "${e.name}" es demasiado grande. Tama\xf1o m\xe1ximo: 100 MB`);return}m.add(n),t.push(e),console.log(`Archivo v\xe1lido agregado: ${e.name} (${e.size} bytes)`)}),0===t.length){console.log("No hay archivos v\xe1lidos en esta selecci\xf3n"),L();return}f=[...f,...t],t.forEach(e=>{C(e)}),L(),console.log(`${t.length} archivos v\xe1lidos procesados. Total: ${f.length}`)}function x(){try{let e=new DataTransfer;a.files=e.files,console.log("Input de archivos limpiado completamente")}catch(t){console.error("Error al limpiar el input de archivo:",t);let n=a.cloneNode(!0);a.parentNode.replaceChild(n,a),a=l.querySelector('input[type="file"]'),a.addEventListener("change",function(e){e.target.files.length>0&&$(Array.from(e.target.files))})}}function L(){try{let e=new DataTransfer;f.forEach(t=>{e.items.add(t)}),a.files=e.files,console.log(`Input actualizado con ${a.files.length} archivos v\xe1lidos.`)}catch(t){console.error("Error al actualizar el input de archivo:",t)}}function C(e,t=null){var n;let i=b(e),a=document.createElement("div");if(a.className="hb-preview-item",a.id=`hb-preview-${i}`,a.dataset.filename=e.name,null!==t){let o=document.createElement("input");o.type="hidden",o.name=`FilesToKeep[${t}]`,o.value=e.name,o.className="file-to-keep",a.appendChild(o)}if(!l.hasAttribute("hidden")){let s=document.createElement("button");s.type="button",s.className="hb-delete-button",s.innerHTML='<i class="fas fa-times"></i>',s.addEventListener("click",function(e){e.stopPropagation(),f=f.filter(e=>b(e)!==i),m.delete(i),a.remove(),L(),function e(){let t=document.querySelectorAll(".file-to-keep");t.forEach((e,t)=>{e.name=`FilesToKeep[${t}]`})}()}),a.appendChild(s)}let d=(n=e,["image/","application/pdf","video/","audio/","text/",].some(e=>n.type.startsWith(e)));if(d){let c=document.createElement("button");c.type="button",c.className="hb-fullscreen-button",c.innerHTML='<i class="fas fa-expand"></i>',c.addEventListener("click",function(t){t.stopPropagation(),w(e)}),a.appendChild(c)}else{let p=document.createElement("a");p.className="hb-fullscreen-button",p.innerHTML='<i class="fas fa-download"></i>',p.href=URL.createObjectURL(e),p.download=e.name,p.addEventListener("click",function(e){e.stopPropagation()}),a.appendChild(p)}let u;if(e.type.startsWith("image/")){let h=document.createElement("img");h.src=URL.createObjectURL(e),u=h}else{let y=document.createElement("div");y.className="hb-file-icon";let g="fas fa-file";e.type.includes("pdf")?g="fas fa-file-pdf":e.type.includes("word")||e.name.endsWith(".doc")||e.name.endsWith(".docx")?g="fas fa-file-word":e.type.includes("excel")||e.name.endsWith(".xls")||e.name.endsWith(".xlsx")?g="fas fa-file-excel":e.type.includes("video")?g="fas fa-file-video":e.type.includes("audio")?g="fas fa-file-audio":e.type.includes("zip")||e.type.includes("rar")||e.type.includes("archive")?g="fas fa-file-archive":e.type.includes("text")&&(g="fas fa-file-alt");let v=document.createElement("i");v.className=g,y.appendChild(v);let E=document.createElement("span");E.textContent=function e(t){if(t.type){if(t.type.includes("spreadsheetml")||t.type.includes("excel"))return"EXCEL";if(t.type.includes("wordprocessingml")||t.type.includes("document"))return"WORD";if(t.type.includes("presentationml")||t.type.includes("powerpoint"))return"POWERPOINT";let n=t.type.split("/");return n.length>1?n[1].toUpperCase():n[0].toUpperCase()}let l=t.name.split(".").pop().toLowerCase();return({pdf:"PDF",doc:"WORD",docx:"WORD",xls:"EXCEL",xlsx:"EXCEL",ppt:"POWERPOINT",pptx:"POWERPOINT",zip:"ZIP",rar:"RAR",txt:"TEXT"})[l]||"FILE"}(e),y.appendChild(E),u=y}a.appendChild(u);let $=document.createElement("div");$.className="hb-file-name",$.textContent=e.name,$.title=e.name,a.appendChild($),d?a.addEventListener("click",function(){w(e)}):a.addEventListener("click",function(){let t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=e.name,document.body.appendChild(t),t.click(),document.body.removeChild(t)}),r.appendChild(a)}function w(e){if(c.innerHTML="",u.style.top="15px",u.style.left="auto",u.style.right="15px",p.style.top="auto",p.style.left="0",p.style.right="0",p.style.bottom="15px",p.textContent=`${e.name} (${function e(t){if(0===t)return"0 Bytes";let n=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,n)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][n]}(e.size)})`,e.type.startsWith("image/")){let t=document.createElement("img");t.src=URL.createObjectURL(e),c.appendChild(t)}else if("application/pdf"===e.type){let n=document.createElement("div");n.className="hb-pdf-container";let l=document.createElement("iframe");l.src=URL.createObjectURL(e),n.appendChild(l),c.appendChild(n)}else if(e.type.startsWith("video/")){let i=document.createElement("video");i.controls=!0,i.autoplay=!1,i.style.maxWidth="95%",i.style.maxHeight="95%";let a=document.createElement("source");a.src=URL.createObjectURL(e),a.type=e.type,i.appendChild(a),c.appendChild(i)}else if(e.type.startsWith("audio/")){let o=document.createElement("div");o.style.width="80%",o.style.maxWidth="600px",o.style.backgroundColor="rgba(255, 255, 255, 0.1)",o.style.padding="20px",o.style.borderRadius="10px";let r=document.createElement("audio");r.controls=!0,r.style.width="100%";let s=document.createElement("source");s.src=URL.createObjectURL(e),s.type=e.type,r.appendChild(s),o.appendChild(r),c.appendChild(o)}else if(e.type.startsWith("text/")){let h=document.createElement("div");h.style.width="90%",h.style.height="90%",h.style.backgroundColor="white",h.style.padding="20px",h.style.borderRadius="8px",h.style.overflow="auto";let f=new FileReader;f.onload=function(e){let t=document.createElement("pre");t.style.textAlign="left",t.style.whiteSpace="pre-wrap",t.style.wordBreak="break-word",t.textContent=e.target.result,h.appendChild(t)},f.readAsText(e),c.appendChild(h)}else{let m=document.createElement("div");m.className="hb-file-preview";let y=document.createElement("p");y.textContent="Este tipo de archivo no se puede previsualizar directamente en el navegador.",y.style.marginBottom="20px",m.appendChild(y);let g=document.createElement("button");g.type="button",g.className="hb-external-open-button",g.innerHTML='<i class="fas fa-external-link-alt"></i> Abrir en nueva ventana',g.addEventListener("click",function(){let t=URL.createObjectURL(e);window.open(t,"_blank")}),m.appendChild(g),c.appendChild(m)}document.body.classList.add("hb-body-no-scroll"),d.style.display="flex"}!function e(){if(!s||0===s.length)return;r.removeAttribute("hb-files");let t=document.querySelector(".hb-loading-indicator");t&&t.remove();let n=document.createElement("div");n.style.width="100%",n.style.marginBottom="20px",r.parentNode.insertBefore(n,r);let l=document.createElement("div");l.className="hb-loading-indicator",l.innerHTML=`
      <div class="hb-spinner"></div>
      <p>Cargando archivos, por favor espere...</p>
      <p class="hb-loading-count">0/${s.length} archivos cargados</p>
    `,n.appendChild(l);let i=0,a=l.querySelector(".hb-loading-count"),o=s.map((e,t)=>{let n=new Date(e.LastModified);return fetch(e?.url).then(e=>e.blob()).then(l=>{let o=new File([l],e?.fileName,{type:l.type,lastModified:n.getTime()}),r=b(o);m.has(r)||(f.push(o),m.add(r),C(o,t)),i++,a.textContent=`${i}/${s.length} archivos cargados`}).catch(t=>{console.error(`Error al cargar el archivo existente ${e?.fileName}:`,t),i++,a.textContent=`${i}/${s.length} archivos cargados`})});Promise.all(o).finally(()=>{n.remove(),L()})}(),o.addEventListener("click",function(){a.click()}),a.addEventListener("change",function(e){e.target.files.length>0&&$(Array.from(e.target.files))}),["dragenter","dragover","dragleave","drop"].forEach(e=>{i.addEventListener(e,y,!1)}),["dragenter","dragover"].forEach(e=>{i.addEventListener(e,g,!1)}),["dragleave","drop"].forEach(e=>{i.addEventListener(e,v,!1)}),i.addEventListener("drop",function(e){let t=e.dataTransfer,n=t.files;$(Array.from(n))}),window.getUploadedFiles=function(){return f},p.style.cursor="ns-resize",p.style.zIndex="102";let _,B,R,N,T;_=!1,B=0,R=0,N=0,T=0,h.addEventListener("mousedown",function(e){document.body.style.userSelect="none",_=!1,B=e.clientX,R=e.clientY;let t=u.getBoundingClientRect(),n=d.getBoundingClientRect();N=B-t.left,T=R-t.top;let l=e=>{let l=e.clientX-B,i=e.clientY-R;if(Math.abs(l)>5||Math.abs(i)>5){_=!0;let a=Math.min(Math.max(0,e.clientX-n.left-N),n.width-t.width),o=Math.min(Math.max(0,e.clientY-n.top-T),n.height-t.height);u.style.left=`${a}px`,u.style.top=`${o}px`,u.style.right="auto"}},i=()=>{_||E(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",i),document.body.style.userSelect=""};document.addEventListener("mousemove",l),document.addEventListener("mouseup",i)}),h.addEventListener("touchstart",function(e){if(document.body.style.userSelect="none",1!==e.touches.length)return;_=!1,B=e.touches[0].clientX,R=e.touches[0].clientY;let t=u.getBoundingClientRect(),n=d.getBoundingClientRect();N=B-t.left,T=R-t.top;let l=e=>{let l=e.touches[0].clientX-B,i=e.touches[0].clientY-R;if(Math.abs(l)>5||Math.abs(i)>5){_=!0;let a=Math.min(Math.max(0,e.touches[0].clientX-n.left-N),n.width-t.width),o=Math.min(Math.max(0,e.touches[0].clientY-n.top-T),n.height-t.height);u.style.left=`${a}px`,u.style.top=`${o}px`,u.style.right="auto"}},i=()=>{_||E(),document.removeEventListener("touchmove",l),document.removeEventListener("touchend",i),document.body.style.userSelect=""};document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",i)});let W,k;W=!1,(t=p).addEventListener("mousedown",function(e){W=!0,k=e.clientY-t.getBoundingClientRect().top,e.preventDefault()}),document.addEventListener("mousemove",function(e){if(W&&t===document.getElementById("hb-fileDetails")){let n=e.clientY-k,l=window.innerHeight-t.offsetHeight;t.style.bottom="auto",t.style.top=`${Math.min(Math.max(0,n),l)}px`}}),document.addEventListener("mouseup",function(){W=!1}),t.addEventListener("touchstart",function(e){W=!0,k=e.touches[0].clientY-t.getBoundingClientRect().top,e.preventDefault()}),document.addEventListener("touchmove",function(e){if(W&&t===document.getElementById("hb-fileDetails")){let n=e.touches[0].clientY-k,l=window.innerHeight-t.offsetHeight;t.style.bottom="auto",t.style.top=`${Math.min(Math.max(0,n),l)}px`}},{passive:!1}),document.addEventListener("touchend",function(){W=!1})}